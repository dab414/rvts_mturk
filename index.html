<html>
<head>
<script type = 'text/javascript' src = 'https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js'></script>
<script type = 'text/javascript' src = 'js/counterBalance.js'></script>
<script type = 'text/javascript' src = 'js/rvts_functions.js'></script>
<script src = 'https://timbrady.org/turk/TimTurkTools.js'></script>
<link rel="stylesheet" href="css/rvts_style.css" type="text/css" charset="utf-8"/>

<script>

$(document).ready(function(){

	// Initialize trial vars and set global vars


	
	// Initializing 
	var leftpoints = 1;
	var rightpoints = 1;
	var rt = '';
	var target_stimulus_assign = document.querySelectorAll('.target_stimulus'); // i actually don't know what this is for
	var newPoints = [];
	var totalPoints = 0;
	var stim = {};
	var key_code = {};
	var task_attempt = '';
	var trial = 0;
	var transition = 'StartBlock';
	var last_response;
	var response_location = ''

	// Global vars
	var trialStruct = new Array();
	var startExpTime = new Date();
	var point_threshold = 5;
	var rsi = 500;

	// Set initial state of html
	$('#container').hide();
	$('#debrief').hide();
	$('#error').hide();
	$('#leftpoints').html(leftpoints);
	$('#rightpoints').html(rightpoints);
	$('#firstClick').click(startExperiment);

	// Grab counter balance object
	key_code = counterBalance(Math.floor(Math.random() * 8));


	

	function startExperiment() {
		//startTime = new Date(); // for recording RT on trial one

		// transition html from instructions to experiment
		$('#instructions').hide();	
		$('#container').show();
		$('.target_stimuli').hide();

		// begin experiment 
		runTrial()
	}



	function runTrial() {

		// for development purposes
		$('#footer').html('<p>Total Points: ' + totalPoints + '</p><p>D: ' + key_code['68'] + ', F: ' + key_code['70'] + ', </p><p>J: ' + key_code['74'] + ', K: ' + key_code['75'] + '</p>');

		// update trial count
		trial += 1

		//console.log(stim_shape);

		setTimeout(function(){
			// this function displays the new stimulus and makes an object with information about what the stimulus is
			stim = generateStim(Math.floor(Math.random() *2), Math.floor(Math.random() *2));

			// start recording RTs
      startTime = new Date();
			
			//calling 'document' means the command applies to entire document
			//'keydown' is the command that tells jquery to respond when a key is pressed
			//'listenForKeys' is an arbitrary name that makes this specific keydown call unique, and I can unbind it specifically 
			//'event' stores which key gets pressed, returned in ASCI key code, decipher from console
			$(document).bind('keydown.listenForKeys', function(event){

				//if response is shape, execute all this
				//this blocks of code need to be general across counter balancing

				// if the key that is pressed is one of the four valid response keys, execute all the following
				if ($.inArray(event.which, [68, 70, 74, 75]) !== -1){
					// new development (2/27)
					
					// subtract the time from the end of rsi to the time right now (at response) aka response time
					rt = new Date() - startTime;
          console.log(rt);

					// stop listening for keys
					$(document).unbind('keydown.listenForKeys');					
			

					// code task attempt 
					if (key_code[String(event.which)] == 'tri_key' | key_code[String(event.which)] == 'circle_key') {
						task_attempt = 'shape';
					} else if (key_code[String(event.which)] == 'blue_key' | key_code[String(event.which)] == 'red_key') {
						task_attempt = 'color';
					}

					// code transition
					
					if (trial != 1) {
						if (task_attempt == last_response) {
							transition = 'Repeat';
						} else transition = 'Switch';
					}
					
					
					
					// this function takes in the current state and updates the total points and logs whether they made an error
					[totalPoints, error] = updateTotalPoints(task_attempt, String(event.which), key_code, stim, totalPoints, leftpoints, rightpoints);

					// get the response location
					response_location = updatePoints_giveLocation(task_attempt, leftpoints, rightpoints, key_code, 1)

					console.log([totalPoints, error]);


					// (2/28) -- Look in general journal for updates


					// update data storage
					
					trialStruct.push({
						'trial': trial,
						'transition': transition,
            'error': error,
            'totalPoints': totalPoints,
            'leftpoints': leftpoints,
            'rightpoints': rightpoints,
            'response_location': response_location,
            'task_attempt': task_attempt,
            'rt': rt
					})
					

					// if they made an error, start the error procedure
					if (error == 1) {
						$('#error').show();
						setTimeout(function(){
							$('#error').hide();
						}, 500);
					}

					$('.target_stimuli').hide();

					//update points
					[leftpoints, rightpoints] = updatePoints_giveLocation(task_attempt, leftpoints, rightpoints, key_code, 0);
					$('#leftpoints').html(leftpoints);
					$('#rightpoints').html(rightpoints);

					if (totalPoints > point_threshold){
						endExperiment();
					} else {runTrial();}
				}

			}); // end function listen for keys
		}, rsi); // the rsi

		last_response = task_attempt;
    console.log('am i running?');

	} // end runTrial()

	
	function endExperiment(){ // will eventually serve as endBlock() 
		$('#debrief').show();
		$('#container').hide();
    $('#footer').hide(); // for development
		blockTime = new Date() - startExpTime;
		console.log(blockTime);
		$('#finaltime').html(Math.round(blockTime/1000) + ' seconds.');
    blockStruct = { // will eventually have to change to blockStruct.push({})
      'block_time': blockTime,
      'example': 'yup in a heave',
      'trialStruct': trialStruct
    }
	}
	
  $('#submit_data').click(function(){ // not sure why i had to do this like this here but not on line 44
    saveData(blockStruct);
  });
	
  function saveData(incoming){
    curDate = new Date();

    curData = {
      'id': $('#comments').val(),
      'curTime': curDate.today() + '@' + curDate.timeNow(),
      'screen_width': screen.width,
      'screen_height': screen.height,
      'window_width': $(window).width(),
      'window_height': $(window).height(),
      'blockStruct': incoming
    }

    sendToServer(curData);
  }

	function sendToServer(current_data){
		var dataToServer = {
      'experiment': 'rVTS',
      'current_data': JSON.stringify(current_data)};

		console.log(dataToServer);

		$.post(
			url = 'cgi-bin/save_data.py',
			data = dataToServer,
			success = function(){
				$('#data_status').html('Everything is chill.');
			}).fail(function(){
				$('#data_status').html('Everything sucks.');
			});
	}

}); // end $$(document).ready(function(){})



</script>

</head>
<body>

	<div id = 'instructions'>
		<p> This is an experiment all about how awesome <b>David Braun</b> is. Please view these shapes and rate how awesome <b>David Braun</b> is on a scale from 1 (completely rad) to 7 (totally gnarlie). Note to self: tell them to disable flux or anything else that messes with color.</p>
		<p><b>Keys:</b></p>
		<p>Color: Red = d; Blue = f</p>
		<p>Shape: Circle = j; Triangle = k</p>

		<div class = 'experimentButton'>
			<a href = '#' id = 'firstClick'>Start Experiment</a>
		</div>
	</div>


	
	<div id = 'container'>
		<div id = 'left_contain'>
			<p id = 'leftpoints' class = 'points'>4</p>
		</div>
		<div id = 'tri_contain'>
			<div class = 'target_stimuli' id = 'blue_triangle'></div>
			<div class = 'target_stimuli' id = 'blue_circle'></div>
			<div class = 'target_stimuli' id = 'red_triangle'></div>
			<div class = 'target_stimuli' id = 'red_circle'></div>
		</div>
		<div id = 'right_contain'>
			<p id = 'rightpoints' class = 'points'>6</p>
		</div> 
	</div>

	
	<div id = 'error'>
		<p>ERROR!</p>
	</div>
	

	<div id = 'debrief'>
		<p>Congrats! It's all over! Please leave comments below.</p>
		<p>You completed this task in:</p>
		<p id = 'finaltime'> fill</p>
		<p id = 'data_status'>fill</p><br><br>

    <textarea id = 'comments' style = 'width: 300px; height: 200px'></textarea><br><br>

    <div class = 'experimentButton'>
      <a id = 'submit_data' href = '#'>Submit</a>
    </div>

	</div>

	<!-- For development purposes -->
	<div id = 'footer'>
	</div>

<!-- I think mturk adds a submit button with ID #submitButton at the bottom -->

</body>
</html>