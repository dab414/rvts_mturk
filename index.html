<html>
<head>
<script type = 'text/javascript' src = 'https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js'></script>
<script type = 'text/javascript' src = 'js/counterBalance.js'></script>
<script type = 'text/javascript' src = 'js/rvts_functions.js?v=3'></script>
<script src = 'https://timbrady.org/turk/TimTurkTools.js'></script>
<link rel="stylesheet" href="css/rvts_style.css" type="text/css" charset="utf-8"/>

<script>

$(document).ready(function(){

	// Initialize trial vars and set global vars
	// Initializing 
	var leftpoints = 1;
	var rightpoints = 1;
	var rt = '';
	//var target_stimulus_assign = document.querySelectorAll('.target_stimulus'); // i actually don't know what this is for
	var newPoints = [];
	var totalPoints = 0;
	var stim = {};
	var task_attempt = '';
	var trial = 0;
	var transition = 'StartBlock';
	var last_response;
	var response_location = ''
	var total_error = 0; // for practice 

	// Global vars
	var trialStruct = new Array();
	var startExpTime = new Date();
	var point_threshold = 5;
	var rsi = 500;

	// send_args() + 
	// the url to ./run

	$('#run_link').click(function(){
		$('#run_link').attr('href', send_args() + $.param(key_code));
		console.log(send_args());
	});

	// Set initial state of html
	$('#experiment').hide();
	$('#end_practice').hide();
	$('#div_detail').hide();

	// Initial buttons
	$('#written_instructions').click(function(){
		$('#introduction').hide();
		$('#div_detail').show();
		$('#p_detail').html("Here is where I'll essentially write out the transcript of the video for people who prefer reading to listening to my beautiful voice.");
	});

	$('#hit_detail').click(function(){
		$('#introduction').hide();
		$('#div_detail').show();
		$('#p_detail').html("Here is where I'll list out basic info about the HIT.");
	});

	$('#go_back').click(function(){
		$('#introduction').show();
		$('#div_detail').hide();
	})

	$('#start_practice').click(startPractice);

	// Grab counter balance object
	var key_code = counterBalance(Math.floor(Math.random() * 8));

	console.log(send_args() + $.param(key_code))

	function startPractice() {
		
		//startTime = new Date(); // for recording RT on trial one
		// transition html from instructions to experiment
		$('#leftpoints').html(leftpoints);
		$('#rightpoints').html(rightpoints);
		$('#introduction').hide();	
		$('#experiment').show();
		$('#error').hide();
		$('.target_stimuli').hide();
		console.log('post init');

		runTrial()
	}

		// begin experiment 
		
	function runTrial() {
		// for development purposes
		$('#footer').html('<p>Total Points: ' + totalPoints + '</p><p>D: ' + key_code['68'] + ', F: ' + key_code['70'] + ', </p><p>J: ' + key_code['74'] + ', K: ' + key_code['75'] + '</p>');

		// update trial count
		trial += 1

		//console.log(stim_shape);

		setTimeout(function(){
			// this function displays the new stimulus and makes an object with information about what the stimulus is
			stim = generateStim(Math.floor(Math.random() *2), Math.floor(Math.random() *2));
			console.log('inner level')
			// start recording RTs
      startTime = new Date();
			
			//calling 'document' means the command applies to entire document
			//'keydown' is the command that tells jquery to respond when a key is pressed
			//'listenForKeys' is an arbitrary name that makes this specific keydown call unique, and I can unbind it specifically 
			//'event' stores which key gets pressed, returned in ASCI key code, decipher from console
			$(document).bind('keydown.listenForKeys', function(event){

				//if response is shape, execute all this
				//this blocks of code need to be general across counter balancing

				// if the key that is pressed is one of the four valid response keys, execute all the following
				if ($.inArray(event.which, [68, 70, 74, 75]) !== -1){
					// new development (2/27)
					
					// subtract the time from the end of rsi to the time right now (at response) aka response time
					rt = new Date() - startTime;
          console.log(rt);

					// stop listening for keys
					$(document).unbind('keydown.listenForKeys');					
			

					// code task attempt 
					if (key_code[String(event.which)] == 'tri_key' | key_code[String(event.which)] == 'circle_key') {
						task_attempt = 'shape';
					} else if (key_code[String(event.which)] == 'blue_key' | key_code[String(event.which)] == 'red_key') {
						task_attempt = 'color';
					}

					// code transition
					
					if (trial != 1) {
						if (task_attempt == last_response) {
							transition = 'Repeat';
						} else transition = 'Switch';
					}
					
					
					
					// this function takes in the current state and updates the total points and logs whether they made an error
					[totalPoints, error] = updateTotalPoints(task_attempt, String(event.which), key_code, stim, totalPoints, leftpoints, rightpoints);

					// get the response location
					response_location = updatePoints_giveLocation(task_attempt, leftpoints, rightpoints, key_code, 1)

					console.log('Totalpoints and error: ' + [totalPoints, error]);


					// (2/28) -- Look in general journal for updates


					// update data storage
					
					trialStruct.push({
						'trial': trial,
						'transition': transition,
      			'error': error,
            'totalPoints': totalPoints,
            'leftpoints': leftpoints,
            'rightpoints': rightpoints,
            'response_location': response_location,
            'task_attempt': task_attempt,
            'rt': rt
					})
					

					// if they made an error, start the error procedure
					if (error == 1) {
						$('#error').show();
						setTimeout(function(){
							$('#error').hide();
						}, 500);
					}

					$('.target_stimuli').hide();

					//update points
					[leftpoints, rightpoints] = updatePoints_giveLocation(task_attempt, leftpoints, rightpoints, key_code, 0);
					$('#leftpoints').html(leftpoints);
					$('#rightpoints').html(rightpoints);

					if (totalPoints > point_threshold){
						endPractice(total_error); 
					} else {
						total_error += error;
						console.log('Total errors: ' + total_error);
						runTrial();
					}
				}

			}); // end function listen for keys
		}, rsi); // the rsi

		last_response = task_attempt;
	} // end runTrial()
		

	function endPractice(total_error){
		var accuracy = 1 - (total_error / 16);
		$('#experiment').hide();
		$('#end_practice').show();
		if (accuracy < .75) {
			$('#practice_result').html("You suck, you only had an accuracy of " + accuracy.toFixed(2) * 100 + '%')
		} else $('#practice_result').html("Nice job, you had an accuracy of " + accuracy.toFixed(2) * 100 + '%')

		$('#restart_practice').click(function(){
			$('#end_practice').hide();
			location.reload();
		});
	}; // end endPractice()

}); // end $$(document).ready(function(){})



</script>

</head>
<body>

	<div id = 'introduction'>
		<h1>Welcome to the multitasking experiment.</h1>
		<p> Here is some very generic and high-level description about what's going on. </p>
		<p>This text will eventually be on the right, and there will be a video on the left.</p>

		<div class = 'link_container'>
			<a href = '#' id = 'start_practice' class = 'experimentButton'>Start Practice</a>
			<a href = '#' id = 'written_instructions' class = 'experimentButton'>See written instructions</a>
			<a href = '#' id = 'hit_detail' class = 'experimentButton'>See details about HIT</a>
			<a href = target_link class = 'experimentButton' id = 'run_link'>Skip practice (development)</a>
		</div>
	</div>

	<div id = 'div_detail'>
		<p id = 'p_detail'></p>
		<div class = 'link_container'>
			<a href = '#' id = 'go_back' class = 'experimentButton'>Go back to main screen</a>
		</div>
	</div>
	
	<div id = 'experiment'>
		<div id = 'container'>
			<div id = 'left_contain'>
				<p id = 'leftpoints' class = 'points'>4</p>
			</div>
			<div id = 'tri_contain'>
				<div class = 'target_stimuli' id = 'blue_triangle'></div>
				<div class = 'target_stimuli' id = 'blue_circle'></div>
				<div class = 'target_stimuli' id = 'red_triangle'></div>
				<div class = 'target_stimuli' id = 'red_circle'></div>
			</div>
			<div id = 'right_contain'>
				<p id = 'rightpoints' class = 'points'>6</p>
			</div> 
		</div>

		
		<div id = 'error'>
			<p>ERROR!</p>
		</div>
	</div>

	<div id = 'end_practice'>
		<p>That's it for the practice.</p>
		<p id = 'practice_result'></p>
		<p>If you think you have the hang of it, go ahead and continue on to the experiment.</p>
		<p>Otherwise, feel free to try those practice trials again.</p>
		
		<div class = 'link_container'>
			<a id = 'restart_practice' class = 'experimentButton' href = '#'>Retry Practice</a> 
			<a id = 'start_experiment' class = 'experimentButton' href = 'run'>Continue to the Experiment</a>
		</div>

	</div>

	<!-- For development purposes -->
	<div id = 'footer'>
	</div>

<!-- I think mturk adds a submit button with ID #submitButton at the bottom -->

</body>
</html>